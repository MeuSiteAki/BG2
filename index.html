<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <title>Painel de Controle ‚Äî BURGUER GRILL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" href="/meu-favicon.ico" />

  <style>
    :root {
      --bg: #121212;
      --card: #1e1e1e;
      --border: #333;
      --accent: #ffbf00;
      --danger: #d32f2f;
      --success: #25d366;
      --text: #eee;
      --muted: #aaa;
    }

    * {
      box-sizing: border-box
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: Arial, sans-serif;
      margin: 0;
    }

    /* Login */
    #login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #121212;
      color: #fff;
    }

    #login-screen input {
      margin: 8px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #1e1e1e;
      color: #fff;
      width: 280px;
    }

    #login-screen button {
      margin-top: 12px;
    }

    header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }

    header h1 {
      margin: 0;
      color: var(--accent);
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .actions .btn {
      min-width: 140px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      padding: 10px 20px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .tab-btn {
      background: #222;
      color: var(--accent);
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .tab-btn.active {
      background: var(--accent);
      color: #000;
    }

    .tab {
      display: none;
      padding: 16px 20px;
    }

    .tab.active {
      display: block;
    }

    .subtabs {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .subtab-btn {
      background: #222;
      color: var(--accent);
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .subtab-btn.active {
      background: var(--accent);
      color: #000;
    }

    .subtab {
      display: none;
    }

    .subtab.active {
      display: block;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .card {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 12px;
    }

    .muted {
      color: var(--muted);
    }

    .btn {
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-accent {
      background: var(--accent);
      color: #000;
    }

    .btn-outline {
      background: #222;
      color: var(--accent);
      border: 1px solid var(--accent);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-success {
      background: var(--success);
      color: #fff;
    }

    /* Mesas */
    .mesas-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      transition: opacity .2s ease;
    }

    .mesa-card {
      border-radius: 10px;
      padding: 12px;
      transition: border-color .2s ease, transform .2s ease, box-shadow .2s ease, opacity .2s ease;
    }

    .mesa-card.livre {
      border-color: var(--success);
    }

    .mesa-card.ocupada {
      border-color: var(--danger);
    }

    .mesa-items {
      border-top: 1px dashed var(--border);
      margin-top: 8px;
      padding-top: 8px;
      max-height: 220px;
      overflow: auto;
    }

    .mesa-total {
      margin-top: 8px;
      font-weight: bold;
      color: var(--accent);
    }

    /* Destaque no celular */
    .mesa-card.highlight {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent);
      transform: scale(1.02);
    }

    .mesas-grid.highlight-mode .mesa-card:not(.highlight) {
      opacity: 0.25;
      pointer-events: none;
    }

    @media (max-width:768px) {
      .mesas-grid.highlight-mode {
        grid-template-columns: 1fr;
      }

      .mesa-card.highlight {
        transform: scale(1.03);
      }
    }

    /* Bot√£o flutuante */
    #floating-toggle {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 1000;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 50px;
      padding: 12px 16px;
      font-weight: bold;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
      cursor: pointer;
      display: none;
    }

    /* Modal carrinho */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 999;
      overflow: auto;
    }

    .modal-content {
      max-width: 900px;
      margin: 40px auto;
      background: #1a1a1a;
      padding: 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .menu-section {
      margin-bottom: 14px;
      border: 1px solid #333;
      border-radius: 8px;
      overflow: hidden;
    }

    .menu-section-header {
      background: #222;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .menu-section-header h3 {
      margin: 0;
      color: var(--accent);
      font-size: 1rem;
    }

    .menu-section-header .toggle {
      background: #333;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 30px;
    }

    .menu-items {
      display: none;
      padding: 10px 12px;
      background: #1f1f1f;
    }

    .menu-item {
      background: #222;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .menu-item h4 {
      margin: 0;
      color: #fff;
      font-size: 0.95rem;
    }

    .menu-item small {
      color: var(--muted);
    }

    .carrinho-list div {
      padding: 6px 0;
      border-bottom: 1px dashed #333;
    }

    .carrinho-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 12px;
    }

    /* Hist√≥rico */
    .hist-list .card {
      margin-bottom: 10px;
    }

    .hist-total {
      margin-top: 8px;
      font-weight: bold;
      color: var(--accent);
    }

    @media (max-width:1024px) {

      .grid,
      .mesas-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width:768px) {

      .grid,
      .mesas-grid {
        grid-template-columns: 1fr;
      }

      .btn {
        padding: 10px 12px;
      }
    }

    select {
      background: #222;
      color: #fff;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 8px;
    }

    label {
      font-size: 0.9rem;
      margin-right: 6px;
    }
    .menu-items.show {
  display: block;
}
.swal-radio {
  color: #000000 !important;
}
.swal2-radio label {
  color: #000000 !important;
}

  </style>
</head>

<body>
  <!-- Tela de Login -->
  <div id="login-screen">
    <h2><i class="fas fa-lock"></i> Login ‚Äî BURGUER GRILL</h2>
    <input id="login-email" type="email" placeholder="Email">
    <div style="position:relative; width:280px;">
      <input id="login-password" type="password" placeholder="Senha"
        style="width:95%; padding:10px; border-radius:6px; border:1px solid #333; background:#1e1e1e; color:#fff;">
      <i id="toggle-password" class="fas fa-eye"
        style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:#aaa;"></i>
    </div>
    <button id="btn-login" class="btn btn-accent"><i class="fas fa-sign-in-alt"></i> Entrar</button>
    <div id="login-error" class="muted" style="margin-top:10px;"></div>

  </div>

  <!-- Painel principal -->
  <div id="main-panel" style="display:none;">
    <header>
      <h1><i class="fas fa-receipt"></i> Painel de Controle ‚Äî BURGUER GRILL</h1>
      <div class="actions" style="display:flex; gap:8px;">
        <button id="btn-pdf" class="btn btn-accent"><i class="fas fa-file-pdf"></i> Baixar PDF</button>
        <button id="btn-apagar-tudo" class="btn btn-danger"><i class="fas fa-trash"></i> Apagar pedidos</button>
        <button id="btn-bip" class="btn btn-outline"><i class="fas fa-bell"></i> Bip: ON</button>

      </div><br>
      <button id="btn-logout" class="btn btn-outline"><i class="fas fa-sign-out-alt"></i> Logout</button>
      <a href="index2.html"><button class="btn btn-outline"><i class="fas fa-sign-out-alt"></i> Menu</button></a>
      
    </header>

    <div class="tabs">
      <button class="tab-btn" onclick="openTab('delivery')"><i class="fas fa-truck"></i> Delivery</button>
      <button class="tab-btn" onclick="openTab('mesas')"><i class="fas fa-chair"></i> Mesas</button>
    </div>

    <!-- Delivery -->
    <section id="delivery" class="tab">
      <div class="subtabs">
        <button class="subtab-btn active" onclick="openSubtab('delivery-list')">Pedidos</button>
        <button class="subtab-btn" onclick="openSubtab('delivery-hist')">Hist√≥rico</button>
      </div>
      <div id="delivery-list" class="subtab active">
        <div class="grid" id="orders-grid"></div>
        <div class="muted" id="orders-count" style="margin-top:8px;"></div>
      </div>
      <div id="delivery-hist" class="subtab">
        <div class="hist-list" id="delivery-historico"></div>
        <div class="hist-total" id="delivery-total"></div>
      </div>
    </section>

    <!-- Mesas -->
    <section id="mesas" class="tab">
      <div class="subtabs">
        <button class="subtab-btn active" onclick="openSubtab('mesas-controle')">Controle</button>
        <button class="subtab-btn" onclick="openSubtab('mesas-hist')">Hist√≥rico</button>
      </div>
      <div id="mesas-controle" class="subtab active">
        <div class="mesas-grid" id="mesas-grid"></div>
      </div>
      <div id="mesas-hist" class="subtab">
        <div class="hist-list" id="mesas-historico"></div>
        <div class="hist-total" id="mesas-total"></div>
      </div>
    </section>
  </div>

  <!-- Bot√£o flutuante para alternar destaque -->
  <button id="floating-toggle"><i class="fas fa-layer-group"></i> Ver todas as mesas</button>

  <!-- Modal de menu com carrinho -->
  <div id="menu-modal" class="modal">
    <div class="modal-content">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
        <h2>Mesa <span id="mesa-atual"></span> ‚Äî Adicionar itens</h2>
        <button class="btn btn-danger" onclick="window.fecharMenuMesa()"><i class="fas fa-times"></i> Fechar</button>
      </div>

      <div id="menu-produtos"></div>

      <h3 style="margin-top:12px;"><i class="fas fa-shopping-basket"></i> Itens selecionados</h3>
      <div id="carrinho-list" class="carrinho-list"></div>

      <div class="carrinho-actions">
        <button class="btn btn-outline" onclick="window.limparCarrinho(window.mesaAtual)"><i class="fas fa-trash"></i>
          Limpar</button>
        <button class="btn btn-accent" onclick="window.confirmarCarrinho(window.mesaAtual)"><i class="fas fa-check"></i>
          Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    // Firebase (configura√ß√£o original)
    const firebaseConfig = {
      apiKey: "AIzaSyBlyifaLH-2uUcCybMgjV5nSvOnFtv-Ht0",
      authDomain: "pedidodegas-ac6de.firebaseapp.com",
      projectId: "pedidodegas-ac6de",
      storageBucket: "pedidodegas-ac6de.firebasestorage.app",
      messagingSenderId: "1015887736520",
      appId: "1:1015887736520:web:a7de5fd3208d6a0afa3ffd",
      measurementId: "G-VGNYJD2KK1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Elementos
    const ordersGrid = document.getElementById('orders-grid');
    const ordersCountEl = document.getElementById('orders-count');
    const mesasGrid = document.getElementById('mesas-grid');
    const deliveryHistEl = document.getElementById('delivery-historico');
    const deliveryTotalEl = document.getElementById('delivery-total');
    const mesasHistEl = document.getElementById('mesas-historico');
    const mesasTotalEl = document.getElementById('mesas-total');
    const floatingToggle = document.getElementById('floating-toggle');

    // Estado global (Sincronizado via Firebase agora)
    window.mesasState = {};
    window.carrinhoMesa = {};
    window.mesaAtual = null;
    window.highlightMesa = null;

    // --- FUN√á√ïES DE SINCRONIZA√á√ÉO FIREBASE (Substituem o LocalStorage) ---
    async function saveMesaFirebase(numero) {
      const mesaData = window.mesasState[numero];
      if (mesaData && mesaData.status === 'Ocupada') {
        await setDoc(doc(db, "mesasAtivas", numero.toString()), mesaData);
      } else {
        await deleteDoc(doc(db, "mesasAtivas", numero.toString()));
      }
    }

    // --- CARD√ÅPIO COMPLETO ---
    const menuData = [
      { id: 112, name: 'COMBO FAMILIA', category: 'burguers', price: 100.00 },
      
      { id: 101, name: 'Grill Burguer', category: 'burguers', price: 32.00 },
      { id: 102, name: 'Picanha Grill', category: 'burguers', price: 34.00 },
      { id: 103, name: 'Burguer de Fil√©', category: 'burguers', price: 33.00 },
      { id: 104, name: 'Caramelizado', category: 'burguers', price: 27.00 },
      { id: 105, name: 'Smash Gill', category: 'burguers', price: 20.00 },
      { id: 106, name: 'Smash Grill Duplo', category: 'burguers', price: 22.00 },
      { id: 107, name: 'Grill Cl√°ssico', category: 'burguers', price: 24.00 },
      { id: 108, name: 'Grill Cheddar', category: 'burguers', price: 23.00 },
      { id: 109, name: 'Frango Burguer', category: 'burguers', price: 23.00 },
      { id: 113, name: 'RIB Burguer', category: 'burguers', price: 33.00,},
      { id: 110, name: 'Kids', category: 'burguers', price: 12.00 },
      { id: 201, name: 'Fritas P', category: 'fritas', price: 8.00 },
      { id: 202, name: 'Fritas M', category: 'fritas', price: 15.00 },
      { id: 203, name: 'Fritas Cheddar e Bacon', category: 'fritas', price: 22.00 },
      { id: 204, name: 'Por√ß√£o de Macaxeira', category: 'fritas', price: 15.00 },
      { id: 301, name: 'Bife Acebolado', category: 'jantinha', price: 30.00 },
      { id: 302, name: 'Jantinha Carne de Sol', category: 'jantinha', price: 30.00 },
      { id: 303, name: 'Jantinha Frango Grill - Coxinha da Asa', category: 'jantinha', price: 27.00 },
      { id: 401, name: 'Picanha na Chapa 400g', category: 'chapas', price: 95.00 },
      { id: 402, name: 'Picanha na Chapa 600g', category: 'chapas', price: 100.00 },
      { id: 403, name: 'Picanha na Chapa 800g', category: 'chapas', price: 130.00 },
      { id: 404, name: 'Picanha na Chapa 1Kg', category: 'chapas', price: 160.00 },
      { id: 501, name: 'Fil√© com Batata', category: 'tiragosto', price: 55.00 },
      { id: 502, name: 'Carne de Sol com Macaxeira', category: 'tiragosto', price: 55.00 },
      { id: 503, name: 'Frango a Passarinho (10 un)', category: 'tiragosto', price: 30.00 },
      { id: 504, name: 'Calabresa com Batata', category: 'tiragosto', price: 25.00 },
      { id: 601, name: 'Arroz Branco P', category: 'adicionais', price: 6.00 },
      { id: 602, name: 'Arroz Branco M', category: 'adicionais', price: 15.00 },
      { id: 604, name: 'Bai√£o P', category: 'adicionais', price: 6.00 },
      { id: 605, name: 'Bai√£o M', category: 'adicionais', price: 15.00 },
      { id: 607, name: 'Salada', category: 'adicionais', price: 5.00 },
      { id: 701, name: 'Skol 600ml', category: 'alcoolico', price: 12.00 },
      { id: 702, name: 'Original 600ml', category: 'alcoolico', price: 14.00 },
      { id: 703, name: 'Brahma 600ml', category: 'alcoolico', price: 12.00 },
      { id: 704, name: 'Amstel 600ml', category: 'alcoolico', price: 12.00 },
      { id: 705, name: 'Heineken 600ml', category: 'alcoolico', price: 17.00 },
      { id: 706, name: 'Budweiser Long Neck 330ml', category: 'alcoolico', price: 12.00 },
      { id: 712, name: 'Corona Long Neck 330ml', category: 'alcoolico', price: 12.00 },
      { id: 711, name: 'Skol Lata', category: 'alcoolico', price: 5.00 },
      { id: 801, name: 'Suco Maracuj√° (Copo)', category: 'bebida', price: 9.00 },
      { id: 828, name: 'Suco Acerola (Copo)', category: 'bebida', price: 8.00 },
      { id: 829, name: 'Suco Maracuj√° (Jarra)', category: 'bebida', price: 27.00 },
      { id: 830, name: 'Suco Acerola (Jarra)', category: 'bebida', price: 20.00 },
      { id: 807, name: 'Coca Cola Lata 350ml', category: 'bebida', price: 6.00 },
      { id: 814, name: 'Coca Cola 1L', category: 'bebida', price: 10.00 },
      { id: 825, name: 'Fanta Laranja 350ml', category: 'bebida', price: 6.00 },
      { id: 815, name: 'Coca Cola 2L', category: 'bebida', price: 15.00 },
      { id: 819, name: 'Soda limonada ', category: 'bebida', price: 6.00 },
      { id: 818, name: '√Ågua sem G√°s', category: 'bebida', price: 4.00 },
      { id: 831, name: '√Ågua com G√°s', category: 'bebida', price: 6.00 },
      { id: 820, name: '√Ågua T√¥nica', category: 'bebida', price: 6.00 },
      { id: 821, name: 'Red Bull', category: 'bebida', price: 15.00 },
      { id: 822, name: 'Guaran√° 1L', category: 'bebida', price: 10.00 },
      { id: 823, name: 'H2OH! Lim√£o', category: 'bebida', price: 8.00 },
      { id: 824, name: 'H2OH! Limoneto', category: 'bebida', price: 8.00 },
      { id: 825, name: 'Ice Lim√£o', category: 'bebida', price: 12.00 },
      { id: 826, name: 'Ice Balada', category: 'bebida', price: 12.00 },
      { id: 827, name: 'Dose Campari', category: 'bebida', price: 15.00 },

    ];


    // Snapshot: atualiza delivery, hist√≥ricos e mesas (TEMPO REAL)
    onSnapshot(query(collection(db, "pedidos")), (snapshot) => {
      const pedidos = [];
      snapshot.forEach(docSnap => pedidos.push({ id: docSnap.id, ...docSnap.data() }));
      renderDelivery(pedidos);
      renderHistoricos(pedidos);
    });

    onSnapshot(collection(db, "mesasAtivas"), (snapshot) => {
      window.mesasState = {}; // Limpa para atualizar com o banco
      snapshot.forEach(docSnap => {
        window.mesasState[docSnap.id] = docSnap.data();
      });
      renderMesas();
    });

    // Olho da senha (login)
    const togglePassword = document.getElementById('toggle-password');
    const passwordInput = document.getElementById('login-password');
    togglePassword.addEventListener('click', () => {
      const isPassword = passwordInput.getAttribute('type') === 'password';
      passwordInput.setAttribute('type', isPassword ? 'text' : 'password');
      togglePassword.classList.toggle('fa-eye');
      togglePassword.classList.toggle('fa-eye-slash');
    });

    // Delivery (lista atual)
    function renderDelivery(pedidosRaw) {
  const pedidos = [...pedidosRaw]
    // üîß agora inclui tamb√©m retirada
    .filter(p => !p.tipo || p.tipo === 'delivery' || p.tipo === 'retirada')
    .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

  ordersGrid.innerHTML = '';
  ordersCountEl.textContent = `${pedidos.length} pedidos`;

  if (pedidos.length === 0) {
    ordersGrid.innerHTML = `<div class="card"><p class="muted"><i class="fas fa-inbox"></i> Nenhum pedido de delivery/retirada.</p></div>`;
    return;
  }

  pedidos.forEach((p, idx) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3><span class="muted">#${idx + 1}</span> ${p.cliente || 'Cliente'}</h3>
      ${p.telefone ? `<p><strong>Telefone:</strong> ${p.telefone}</p>` : ''}
      ${
        p.tipo === 'retirada'
          ? `<p><strong>Tipo:</strong> Retirada no Local</p>`
          : (p.endereco ? `<p><strong>Endere√ßo:</strong> ${p.endereco}${p.bairro ? ' - ' + p.bairro : ''}</p>` : '')
      }
      ${p.pagamento ? `<p><strong>Pagamento:</strong> ${p.pagamento}</p>` : ''}
      <p><strong>Itens:</strong> ${p.itens || ''}</p>
      ${p.obs ? `<p><strong>Obs:</strong> ${p.obs}</p>` : ''}
      ${p.total ? `<p class="mesa-total">Total: R$ ${p.total}</p>` : ''}
      ${p.createdAt ? `<p class="muted">${new Date(p.createdAt).toLocaleString('pt-BR')}</p>` : ''}
    `;
    ordersGrid.appendChild(card);
  });

  // üîî dispara bip somente se houver pedidos e bip estiver ativo
  if (window.bipAtivo && pedidos.length > 0) {
    tocarBip();
  }
}


    // Hist√≥ricos
   function renderHistoricos(pedidosRaw) {
  const histMesas = pedidosRaw
    .filter(p => p.tipo === 'fechamento' && (p.cliente || '').toLowerCase().includes('mesa'))
    .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

  const histDelivery = pedidosRaw
    .filter(p => !p.tipo || p.tipo === 'delivery')
    .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

  // --- Mesas ---
  mesasHistEl.innerHTML = '';
  let totalMesas = 0;
  histMesas.forEach((p, idx) => {
    const t = parseFloat(p.total || 0);
    totalMesas += isNaN(t) ? 0 : t;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3><i class="fas fa-chair"></i> ${p.cliente || 'Mesa'}</h3>
      <p class="muted">#${idx + 1} ‚Äî ${p.createdAt ? new Date(p.createdAt).toLocaleString('pt-BR') : ''}</p>
      ${p.garcom ? `<p><strong>Gar√ßom:</strong> ${p.garcom}</p>` : ''}
      ${p.pagamento ? `<p><strong>Pagamento:</strong> ${p.pagamento}</p>` : ''}
      <p><strong>Itens:</strong> ${p.itens || ''}</p>
      ${p.total ? `<p class="mesa-total">Total: R$ ${p.total}</p>` : ''}
      <button class="btn btn-outline" onclick="window.reimprimirNota('${p.id}')">
        <i class="fas fa-print"></i> Reimprimir
      </button>
    `;
    mesasHistEl.appendChild(card);
  });
  mesasTotalEl.textContent = `Total Mesas: R$ ${totalMesas.toFixed(2).replace('.', ',')}`;

  // --- Delivery ---
  deliveryHistEl.innerHTML = '';
  let totalDelivery = 0;
  histDelivery.forEach((p, idx) => {
    const t = parseFloat(p.total || 0);
    totalDelivery += isNaN(t) ? 0 : t;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3><i class="fas fa-truck"></i> ${p.cliente || 'Cliente'}</h3>
      <p class="muted">#${idx + 1} ‚Äî ${p.createdAt ? new Date(p.createdAt).toLocaleString('pt-BR') : ''}</p>
      <p><strong>Itens:</strong> ${p.itens || ''}</p>
      ${p.total ? `<p class="mesa-total">Total: R$ ${p.total}</p>` : ''}
      <button class="btn btn-outline" onclick="window.reimprimirNota('${p.id}')">
        <i class="fas fa-print"></i> Reimprimir
      </button>
    `;
    deliveryHistEl.appendChild(card);
  });
  deliveryTotalEl.textContent = `Total Delivery: R$ ${totalDelivery.toFixed(2).replace('.', ',')}`;
}
window.reimprimirNota = async function (pedidoId) {
  const docRef = doc(db, "pedidos", pedidoId);
  const snap = await getDocs(query(collection(db, "pedidos")));
  const pedido = (await getDocs(query(collection(db, "pedidos")))).docs.find(d => d.id === pedidoId)?.data();

  if (!pedido) {
    Swal.fire('Erro', 'Pedido n√£o encontrado', 'error');
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  pdf.setFontSize(14);
  pdf.text(`Nota - ${pedido.cliente || 'Cliente'}`, 10, 10);
  pdf.text(`Itens: ${pedido.itens || ''}`, 10, 20);
  if (pedido.total) pdf.text(`Total: R$ ${pedido.total}`, 10, 30);
  if (pedido.pagamento) pdf.text(`Pagamento: ${pedido.pagamento}`, 10, 40);
  pdf.text(`Data: ${new Date(pedido.createdAt).toLocaleString('pt-BR')}`, 10, 50);

  pdf.save(`nota-${pedidoId}.pdf`);
};


    // Render Mesas
    function renderMesas() {
      mesasGrid.innerHTML = '';
      for (let i = 1; i <= 40; i++) {
        const m = window.mesasState[i] || { status: 'Livre', itens: [], total: 0, impresso: [], garcom: '' };
        const card = document.createElement('div');
        card.className = `card mesa-card ${m.status === 'Livre' ? 'livre' : 'ocupada'}`;
        card.setAttribute('data-mesa', i);
        card.innerHTML = `
          <h3><i class="fas fa-chair"></i> Mesa ${i}</h3>
          <div class="muted">Status: <span id="mesa-status-${i}">${m.status}</span></div>
          <div style="margin:8px 0;">
            <label>Gar√ßom:</label>
            <select id="mesa-garcom-${i}" ${m.status === 'Ocupada' ? 'disabled' : ''} onchange="window.selecionarGarcom(${i}, this.value)">
              <option value="">-- selecione --</option>
              <option value="Nicole" ${m.garcom === 'Nicole' ? 'selected' : ''}>Nicole</option>
              <option value="Alana" ${m.garcom === 'Alana' ? 'selected' : ''}>Alana</option>
              
            </select>
          </div>
          <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:6px; margin:8px 0;">
            <button class="btn btn-success" onclick="window.abrirMesa(${i})"><i class="fas fa-door-open"></i> Abrir</button>
            <button class="btn btn-accent" onclick="window.abrirMenuMesa(${i})"><i class="fas fa-plus"></i> Itens</button>
            <button class="btn btn-outline" onclick="window.enviarParaCozinha(${i})"><i class="fas fa-print"></i> Cozinha</button>
            <button class="btn btn-danger" onclick="window.fecharMesa(${i})"><i class="fas fa-door-closed"></i> Fechar</button>
          </div>
          <div class="mesa-items" id="mesa-items-${i}">
            ${m.itens.map(it => `<div>‚Ä¢ ${it.name} ‚Äî R$ ${it.price.toFixed(2)}${it.obs ? ' (Obs: ' + it.obs + ')' : ''}</div>`).join('')}
          </div>
          <div class="mesa-total" id="mesa-total-${i}">Total: R$ ${Number(m.total || 0).toFixed(2).replace('.', ',')}</div>
        `;
        mesasGrid.appendChild(card);
        card.addEventListener('click', (e) => {
          if (e.target.closest('button') || e.target.closest('select')) return;
          setHighlightMesa(i);
        });
      }
      applyHighlightUI();
    }

    function setHighlightMesa(numero) { window.highlightMesa = numero; applyHighlightUI(); }
    function clearHighlight() { window.highlightMesa = null; applyHighlightUI(); }
    function applyHighlightUI() {
      const cards = mesasGrid.querySelectorAll('.mesa-card');
      cards.forEach(c => {
        const n = Number(c.getAttribute('data-mesa'));
        c.classList.toggle('highlight', window.highlightMesa === n);
        if (window.highlightMesa && n !== window.highlightMesa) c.style.display = 'none';
        else c.style.display = 'block';
      });
      floatingToggle.style.display = window.highlightMesa ? 'block' : 'none';
    }
    floatingToggle.addEventListener('click', clearHighlight);

    window.selecionarGarcom = function (numero, nome) {
      if (!window.mesasState[numero]) window.mesasState[numero] = { status: 'Livre', itens: [], total: 0, impresso: [], garcom: '' };
      if (window.mesasState[numero].status === 'Ocupada') return;
      window.mesasState[numero].garcom = nome;
    };

    window.abrirMesa = async function (numero) {
      if (window.mesasState[numero] && window.mesasState[numero].status === 'Ocupada') {
        Swal.fire({ icon: 'error', title: 'Mesa j√° ocupada' }); return;
      }
      const g = document.getElementById(`mesa-garcom-${numero}`).value;
      if (!g) { Swal.fire({ icon: 'warning', title: 'Selecione um gar√ßom' }); return; }

      window.mesasState[numero] = { status: 'Ocupada', itens: [], total: 0, impresso: [], garcom: g };
      await saveMesaFirebase(numero);
      setHighlightMesa(numero);
    };


    // Modal Menu
    window.abrirMenuMesa = function (numero) {
      window.mesaAtual = numero;
      if (!window.carrinhoMesa[numero]) window.carrinhoMesa[numero] = [];
      document.getElementById('mesa-atual').innerText = numero;
      document.getElementById('menu-modal').style.display = 'block';
      renderMenuProdutos(numero);
      renderCarrinho(numero);
    };
    window.fecharMenuMesa = function () { document.getElementById('menu-modal').style.display = 'none'; };

    function renderMenuProdutos(numero) {
  const menuEl = document.getElementById('menu-produtos');
  menuEl.innerHTML = '';
  const categorias = [
    { key: 'burguers', label: 'Burguers' }, { key: 'fritas', label: 'Fritas' },
    { key: 'jantinha', label: 'Jantinha' }, { key: 'chapas', label: 'Chapas' },
    { key: 'tiragosto', label: 'Tira Gosto' }, { key: 'adicionais', label: 'Adicionais' },
    { key: 'bebida', label: 'Bebidas' }, { key: 'alcoolico', label: 'Alco√≥licos' }
  ];

  categorias.forEach(cat => {
    const items = menuData.filter(i => i.category === cat.key);
    if (items.length === 0) return;

    const section = document.createElement('div');
    section.className = 'menu-section';

    // Cabe√ßalho com bot√£o toggle
    const header = document.createElement('div');
    header.className = 'menu-section-header';
    header.innerHTML = `<h3>${cat.label}</h3>
      <button class="toggle">+</button>`;
    section.appendChild(header);

    // Lista de itens
    const itemsWrap = document.createElement('div');
    itemsWrap.className = 'menu-items';
    items.forEach(item => {
      const row = document.createElement('div');
      row.className = 'menu-item';
      row.innerHTML = `
        <div><h4>${item.name}</h4><small>R$ ${item.price.toFixed(2)}</small></div>
        <div style="display:flex; gap:6px;">
          <button class="btn btn-outline" onclick="window.addItemCarrinho(${numero}, ${item.id})">Add</button>
          <button class="btn btn-outline" onclick="window.addItemCarrinhoComObs(${numero}, ${item.id})">Obs</button>
        </div>`;
      itemsWrap.appendChild(row);
    });
    section.appendChild(itemsWrap);

    // Evento de abrir/fechar
    header.querySelector('.toggle').addEventListener('click', () => {
      itemsWrap.classList.toggle('show');
      header.querySelector('.toggle').textContent = itemsWrap.classList.contains('show') ? '‚àí' : '+';
    });

    menuEl.appendChild(section);
  });
}


    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1400, background: '#25d366', color: '#fff' });

    window.addItemCarrinho = function (num, id) {
      const it = menuData.find(i => i.id === id);
      window.carrinhoMesa[num].push({ name: it.name, price: it.price, obs: '' });
      renderCarrinho(num);
      Toast.fire({ icon: 'success', title: it.name });
    };

    window.addItemCarrinhoComObs = async function (num, id) {
      const it = menuData.find(i => i.id === id);
      const { value: obs } = await Swal.fire({ title: it.name, input: 'text', background: '#1a1a1a', color: '#fff', showCancelButton: true });
      if (obs !== undefined) {
        window.carrinhoMesa[num].push({ name: it.name, price: it.price, obs: obs.trim() });
        renderCarrinho(num);
      }
    };

    window.removerItemCarrinho = function (num, idx) { window.carrinhoMesa[num].splice(idx, 1); renderCarrinho(num); };

    function renderCarrinho(num) {
      const el = document.getElementById('carrinho-list'); el.innerHTML = '';
      (window.carrinhoMesa[num] || []).forEach((it, idx) => {
        el.innerHTML += `<div>‚Ä¢ ${it.name} <button class="btn btn-danger" style="padding:2px 5px" onclick="window.removerItemCarrinho(${num}, ${idx})">X</button></div>`;
      });
    }

    window.confirmarCarrinho = async function (num) {
      const carr = window.carrinhoMesa[num] || [];
      if (carr.length === 0) return;
      if (!window.mesasState[num]) window.mesasState[num] = { status: 'Ocupada', itens: [], total: 0, impresso: [], garcom: '' };
      carr.forEach(it => window.mesasState[num].itens.push(it));
      window.mesasState[num].total = window.mesasState[num].itens.reduce((s, i) => s + i.price, 0);
      await saveMesaFirebase(num);
      window.carrinhoMesa[num] = [];
      window.fecharMenuMesa();
    };

   window.enviarParaCozinha = async function (num) {
  const m = window.mesasState[num];
  if (!m || m.itens.length === 0) return;

  // chave para evitar duplicados
  const chave = (it) => `${it.name}||${it.price}||${it.obs || ''}`;
 const novos = m.itens; // imprime sempre todos os itens
if (novos.length === 0) { 
  Swal.fire({ title: 'Nenhum item para enviar' }); 
  return; 
}


  // grava no Firestore j√° no formato esperado pela impressora
  await addDoc(collection(db, "pedidos"), {
    tipo: 'mesa',
    cliente: `Mesa ${num}`,
    garcom: m.garcom,
    itens: novos.map(i => `${i.name}||${i.price.toFixed(2)}||${i.obs || ''}`).join(';'),
    createdAt: new Date().toISOString()
  });

  // marca como impresso
  novos.forEach(it => m.impresso.push(chave(it)));
  await saveMesaFirebase(num);

  Swal.fire({ icon: 'success', title: 'Cozinha avisada' });
};

window.fecharMesa = async function (num) {
  const m = window.mesasState[num];
  if (!m || m.status === 'Livre') return;

  const { value: pag } = await Swal.fire({
    title: 'Pagamento',
    input: 'radio',
    inputOptions: { 
      'NO LOCAL': 'NO LOCAL',  
    },
    background: '#1a1a1a',
    color: '#fff',
    customClass: {
      input: 'swal-radio'
    }
  });

  if (!pag) return;

  // grava fechamento com itens completos
  await addDoc(collection(db, "pedidos"), {
    tipo: 'fechamento',
    cliente: `Mesa ${num}`,
    garcom: m.garcom,
    pagamento: pag,
    itens: m.itens.map(i => `${i.name}||${i.price.toFixed(2)}||${i.obs || ''}`).join(';'),
    total: m.total.toFixed(2),
    createdAt: new Date().toISOString()
  });

  // libera mesa
  window.mesasState[num] = { status: 'Livre', itens: [], total: 0, impresso: [], garcom: '' };
  await saveMesaFirebase(num);
  clearHighlight();
};

   // PDF e Apagar (Com Prote√ß√£o de Gerente)
async function requireManager() {
  const user = auth.currentUser;
  const { value: pwd } = await Swal.fire({
    title: 'Senha Gerente',
    input: 'password',
    background: '#1a1a1a',
    color: '#fff',
    showCancelButton: true
  });
  if (!pwd) return false;
  try {
    await signInWithEmailAndPassword(auth, user.email, pwd);
    return true;
  } catch (e) {
    Swal.fire('Erro', 'Senha incorreta', 'error');
    return false;
  }
}

document.getElementById('btn-apagar-tudo').addEventListener('click', async () => {
  if (!(await requireManager())) return;
  const snap = await getDocs(collection(db, 'pedidos'));
  snap.forEach(d => deleteDoc(doc(db, 'pedidos', d.id)));
  Swal.fire('Limpo');
});

document.getElementById('btn-pdf').addEventListener('click', async () => {
  if (!(await requireManager())) return;
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  pdf.setFontSize(16);
  pdf.text("Relat√≥rio Burguer Grill", 10, 10);

  let y = 20;
  let contador = 1;
  let totalGeral = 0;

  const snap = await getDocs(collection(db, 'pedidos'));
  snap.forEach((d) => {
    const p = d.data();
    const total = parseFloat(p.total || 0);
    if (!isNaN(total)) totalGeral += total;

    pdf.setFontSize(12);
    pdf.text(`#${contador} - ${p.cliente || 'Cliente'}`, 10, y);
    y += 6;
    if (p.garcom) { pdf.text(`Gar√ßom: ${p.garcom}`, 10, y); y += 6; }
    if (p.pagamento) { pdf.text(`Pagamento: ${p.pagamento}`, 10, y); y += 6; }
    if (p.itens) { pdf.text(`Itens: ${p.itens}`, 10, y); y += 6; }
    pdf.text(`Total: R$ ${p.total || '0,00'}`, 10, y); y += 6;
    if (p.createdAt) {
      pdf.text(`Data: ${new Date(p.createdAt).toLocaleString('pt-BR')}`, 10, y);
      y += 10;
    } else {
      y += 10;
    }

    contador++;
    if (y > 270) { pdf.addPage(); y = 20; }
  });

  // Total geral no final
  pdf.setFontSize(14);
  pdf.text(`TOTAL GERAL: R$ ${totalGeral.toFixed(2).replace('.', ',')}`, 10, y);

  pdf.save("relatorio.pdf");
});

    // Auth & Tabs
    window.openTab = function (id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    };

    window.openSubtab = async function (id) {
      if (id.endsWith('-hist')) { if (!(await requireManager())) return; }
      document.querySelectorAll('.subtab').forEach(t => t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    };

    document.getElementById('btn-login').addEventListener('click', async () => {
      const e = document.getElementById('login-email').value;
      const s = document.getElementById('login-password').value;
      try { await signInWithEmailAndPassword(auth, e, s); } catch (err) { alert("Erro login"); }
    });

    document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
      document.getElementById('login-screen').style.display = user ? 'none' : 'flex';
      document.getElementById('main-panel').style.display = user ? 'block' : 'none';
      if (user) openTab('mesas');
    });
// Fun√ß√£o auxiliar para agrupar itens iguais
function agruparItens(itens) {
  const grouped = {};
  itens.forEach(it => {
    const key = it.name + (it.obs || '');
    if (!grouped[key]) {
      grouped[key] = { ...it, qty: 0 };
    }
    grouped[key].qty += 1;
  });
  return Object.values(grouped);
}

window.enviarParaCozinha = async function (num) {
  const m = window.mesasState[num];
  if (!m || m.itens.length === 0) return;

  // Fun√ß√£o para criar a assinatura do item
  const gerarChave = (it) => `${it.name}||${it.price}||${it.obs || ''}`;

  // 1. Contabiliza quantas vezes cada chave j√° foi impressa
  const contagemImpressos = {};
  m.impresso.forEach(c => {
    contagemImpressos[c] = (contagemImpressos[c] || 0) + 1;
  });

  // 2. Filtra apenas o que sobrou (o que √© novo ou repeti√ß√£o nova)
  const novosParaImprimir = [];
  const copiaImpressos = [...m.impresso]; // C√≥pia para atualizar o estado depois

  m.itens.forEach(item => {
    const chave = gerarChave(item);
    if (contagemImpressos[chave] > 0) {
      // Se j√° imprimiu antes, decrementa a contagem e n√£o adiciona nos "novos"
      contagemImpressos[chave]--;
    } else {
      // Se a contagem acabou ou nunca existiu, √© um item novo/repetido
      novosParaImprimir.push(item);
      copiaImpressos.push(chave);
    }
  });

  if (novosParaImprimir.length === 0) {
    Swal.fire({ title: 'Aten√ß√£o', text: 'Todos os itens atuais j√° foram enviados!', icon: 'info' });
    return;
  }

  // 3. Agrupa os novos itens para a comanda sair bonita (ex: 2x Coca)
  const agrupados = agruparItens(novosParaImprimir);

  try {
    // 4. Grava no Firestore para o servidor Node.js ler
    await addDoc(collection(db, "pedidos"), {
      tipo: 'mesa',
      cliente: `Mesa ${num}`,
      garcom: m.garcom || 'Geral',
      itens: agrupados.map(i => `${i.qty}x ${i.name}||${(i.price * i.qty).toFixed(2)}||${i.obs || ''}`).join(';'),
      createdAt: new Date().toISOString()
    });

    // 5. Atualiza o estado da mesa com a nova lista de impressos
    m.impresso = copiaImpressos;
    await saveMesaFirebase(num);

    Swal.fire({ icon: 'success', title: 'Cozinha Avisada!', timer: 1000, showConfirmButton: false });
  } catch (error) {
    console.error("Erro ao enviar:", error);
    Swal.fire('Erro', 'N√£o foi poss√≠vel enviar para a cozinha', 'error');
  }
};

window.fecharMesa = async function (num) {
  const m = window.mesasState[num];
  if (!m || m.status === 'Livre') return;

  const { value: pag } = await Swal.fire({
    title: 'Fechar Mesa ' + num,
    input: 'radio',
    inputOptions: { 
      'PIX': 'PIX',
      'DEBITO': 'DEBITO',
      'CREDITO': 'CREDITO',
      'DINHEIRO': 'DINHEIRO'
    },
    background: '#1a1a1a',
    color: '#fff',
    showCancelButton: true,
    cancelButtonText: 'Voltar'
  });

  if (!pag) return;

  // No fechamento, agrupamos TODOS os itens da mesa para a nota final
  const agrupadosGeral = agruparItens(m.itens);

  try {
    await addDoc(collection(db, "pedidos"), {
      tipo: 'fechamento',
      cliente: `Mesa ${num}`,
      garcom: m.garcom,
      pagamento: pag,
      itens: agrupadosGeral.map(i => `${i.qty}x ${i.name}||${(i.price * i.qty).toFixed(2)}||${i.obs || ''}`).join(';'),
      total: m.total.toFixed(2),
      createdAt: new Date().toISOString()
    });

    // Reseta a mesa para o estado Livre
    window.mesasState[num] = { status: 'Livre', itens: [], total: 0, impresso: [], garcom: '' };
    await saveMesaFirebase(num);
    
    if (typeof clearHighlight === 'function') clearHighlight();

    Swal.fire({ icon: 'success', title: 'Mesa Finalizada!', text: 'Cupom enviado para a impressora principal.' });
  } catch (error) {
    Swal.fire('Erro', 'Erro ao fechar mesa no banco.', 'error');
  }
};


// Estado do bip
window.bipAtivo = true;
const btnBip = document.getElementById('btn-bip');

btnBip.addEventListener('click', () => {
  window.bipAtivo = !window.bipAtivo;
  btnBip.innerHTML = window.bipAtivo 
    ? '<i class="fas fa-bell"></i> Bip: ON' 
    : '<i class="fas fa-bell-slash"></i> Bip: OFF';
});

// Fun√ß√£o para tocar 3 bips curtos
function tocarBip() {
  if (!window.bipAtivo) return;
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  for (let i = 0; i < 1; i++) {
    const osc = audioCtx.createOscillator();
    osc.type = 'square';
    osc.frequency.setValueAtTime(1000, audioCtx.currentTime + i * 0.4);
    osc.connect(audioCtx.destination);
    osc.start(audioCtx.currentTime + i * 0.4);
    osc.stop(audioCtx.currentTime + i * 0.4 + 0.2);
  }
}
// Bloqueios de seguran√ßa (mantidos como no original)
document.addEventListener('keydown', function (e) {
    if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) { e.preventDefault(); }
    if (e.key === 'F12') { e.preventDefault(); }
});
document.addEventListener('keydown', function (event) {
    if (event.ctrlKey && event.shiftKey && event.key === 'I') { event.preventDefault(); }
});
document.addEventListener('contextmenu', function (event) { event.preventDefault(); });
</script>

  </script>
</body>

</html>

<!-- { id: 111, name: 'COMBO GRILL', category: 'burguers', price: 35.99 }, -->